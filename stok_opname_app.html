<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Stok Opname</title>
    <!-- Tailwind CSS CDN untuk styling yang cepat dan modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries untuk Ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Library untuk Ekspor XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles untuk animasi tombol */
        .btn-animation {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .btn-animation:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-animation:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Styling untuk modal pop-up */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal-container:not(.active) .modal-content {
            transform: translateY(-50px);
        }

        /* Dropdown CSS: Defaultnya tersembunyi, hanya muncul saat class 'active' ditambahkan */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 10;
        }
        .dropdown-menu-active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Modal Form Tambah/Edit Produk -->
    <div id="item-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-semibold text-gray-700">Tambah Produk</h2>
                <button id="close-item-modal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            </div>
            
            <!-- Tambahkan div yang bisa di-scroll di sini -->
            <div class="overflow-y-auto max-h-[70vh] pr-2">
                <form id="stock-form">
                    <input type="hidden" id="item-id">
                    <div class="space-y-4">
                        <!-- Input Nama Produk -->
                        <div class="flex flex-col">
                            <label for="item-name" class="text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
                            <input type="text" id="item-name" placeholder="Nama Produk" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <!-- Input Kode Produk -->
                        <div class="flex flex-col">
                            <label for="item-code" class="text-sm font-medium text-gray-700 mb-1">Kode Produk</label>
                            <input type="text" id="item-code" placeholder="Kode Produk"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>

                        <!-- Input Foto Produk dengan tipe file -->
                        <div class="flex flex-col">
                            <label for="item-photo-file" class="text-sm font-medium text-gray-700 mb-1">Pilih Foto Produk</label>
                            <input type="file" id="item-photo-file" accept="image/*"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Input tersembunyi untuk menyimpan data URI foto -->
                            <input type="hidden" id="item-photo-data">
                            <!-- Pratinjau Foto -->
                            <img id="item-photo-preview" src="#" alt="Pratinjau Foto" class="mt-2 hidden rounded-lg max-w-[100px] max-h-[100px] object-contain">
                        </div>

                    </div>
                </form>
            </div>

            <div class="grid grid-cols-1 gap-4 mt-6">
                <!-- Tombol Simpan kembali ke dalam grid tanpa tombol buat deskripsi -->
                <button type="submit" id="form-button" form="stock-form"
                    class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 btn-animation">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Form Tambah Stok -->
    <div id="stock-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Tambah Stok</h2>
                <button id="close-stock-modal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            </div>
            <form id="add-stock-form">
                <div class="space-y-4">
                    <!-- Dropdown Produk -->
                    <div class="flex flex-col">
                        <label for="stock-product" class="text-sm font-medium text-gray-700 mb-1">Pilih Produk</label>
                        <select id="stock-product" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Pilih Produk --</option>
                        </select>
                    </div>
                    <!-- Input Tanggal -->
                    <div class="flex flex-col">
                        <label for="stock-date" class="text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="stock-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Input Jumlah Stok -->
                    <div class="flex flex-col">
                        <label for="stock-quantity" class="text-sm font-medium text-gray-700 mb-1">Jumlah Stok</label>
                        <input type="number" id="stock-quantity" placeholder="Masukkan jumlah stok" required min="1"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Input Catatan -->
                    <div class="flex flex-col">
                        <label for="stock-notes" class="text-sm font-medium text-gray-700 mb-1">Catatan</label>
                        <textarea id="stock-notes" placeholder="Catatan transaksi (misalnya: 'Pembelian dari supplier A')" rows="2"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 btn-animation">
                        Simpan Stok
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Form Kurangi Stok (Stok Keluar) -->
    <div id="out-stock-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Stok Keluar</h2>
                <button id="close-out-stock-modal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            </div>
            <form id="out-stock-form">
                <div class="space-y-4">
                    <!-- Dropdown Produk -->
                    <div class="flex flex-col">
                        <label for="out-stock-product" class="text-sm font-medium text-gray-700 mb-1">Pilih Produk</label>
                        <select id="out-stock-product" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Pilih Produk --</option>
                        </select>
                    </div>
                    <!-- Input Tanggal -->
                    <div class="flex flex-col">
                        <label for="out-stock-date" class="text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="out-stock-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Input Jumlah Stok -->
                    <div class="flex flex-col">
                        <label for="out-stock-quantity" class="text-sm font-medium text-gray-700 mb-1">Jumlah Stok</label>
                        <input type="number" id="out-stock-quantity" placeholder="Masukkan jumlah stok keluar" required min="1"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Input Catatan -->
                    <div class="flex flex-col">
                        <label for="out-stock-notes" class="text-sm font-medium text-gray-700 mb-1">Catatan</label>
                        <textarea id="out-stock-notes" placeholder="Catatan transaksi (misalnya: 'Penjualan ke pelanggan X')" rows="2"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 btn-animation">
                        Kurangi Stok
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus Produk Terpilih -->
    <div id="confirm-delete-selected-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-sm">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Konfirmasi Hapus</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus produk yang dipilih?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-selected-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 btn-animation">
                    Batal
                </button>
                <button id="confirm-delete-selected-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 btn-animation">
                    Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL BARU: OPNAME STOK -->
    <div id="opname-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Opname Stok</h2>
                <button id="close-opname-modal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            </div>
            <form id="opname-form">
                <div class="space-y-4">
                    <!-- Dropdown Produk -->
                    <div class="flex flex-col">
                        <label for="opname-product" class="text-sm font-medium text-gray-700 mb-1">Pilih Produk</label>
                        <select id="opname-product" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Pilih Produk --</option>
                        </select>
                    </div>
                    <!-- Input Jumlah Fisik -->
                    <div class="flex flex-col">
                        <label for="opname-physical-count" class="text-sm font-medium text-gray-700 mb-1">Jumlah Fisik</label>
                        <input type="number" id="opname-physical-count" placeholder="Masukkan jumlah stok fisik" required min="0"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Input Catatan -->
                    <div class="flex flex-col">
                        <label for="opname-notes" class="text-sm font-medium text-gray-700 mb-1">Catatan</label>
                        <textarea id="opname-notes" placeholder="Catatan opname (misalnya: 'Selisih stok karena hilang')" rows="2"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-orange-600 text-white font-semibold py-3 rounded-lg hover:bg-orange-700 btn-animation">
                        Catat Selisih
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL BARU: KONFIRMASI HAPUS SEMUA DATA -->
    <div id="confirm-delete-all-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-sm">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Konfirmasi Hapus Semua</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin **menghapus semua data**? Tindakan ini akan menghapus semua produk dan riwayat transaksi. Tindakan ini tidak bisa dibatalkan.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-all-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 btn-animation">
                    Batal
                </button>
                <button id="confirm-delete-all-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 btn-animation">
                    Hapus Semua
                </button>
            </div>
        </div>
    </div>

    <!-- Halaman utama aplikasi -->
    <div class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Aplikasi Stok Opname</h1>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <button id="show-add-modal-button"
                        class="w-full md:w-auto bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 btn-animation">
                    ➕ Tambah Produk
                </button>

                <!-- Dropdown untuk Aksi Stok -->
                <div class="relative dropdown-container">
                    <button class="bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-600 btn-animation w-full md:w-auto dropdown-btn">
                        Aksi Stok
                    </button>
                    <div class="dropdown-menu absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl">
                        <a href="#" id="show-add-stock-modal-button" class="block px-4 py-2 text-gray-800 hover:bg-indigo-500 hover:text-white">📦 Tambah Stok</a>
                        <a href="#" id="show-out-stock-modal-button" class="block px-4 py-2 text-gray-800 hover:bg-red-500 hover:text-white">📦 Stok Keluar</a>
                        <a href="#" id="show-opname-modal-button" class="block px-4 py-2 text-gray-800 hover:bg-orange-500 hover:text-white">📝 Opname Stok</a>
                    </div>
                </div>

                <!-- Dropdown untuk Opsi Data -->
                <div class="relative dropdown-container">
                    <button class="bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-600 btn-animation w-full md:w-auto dropdown-btn">
                        Opsi Data
                    </button>
                    <div class="dropdown-menu absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl">
                        <a href="#" id="backup-data-button" class="block px-4 py-2 text-gray-800 hover:bg-purple-600 hover:text-white">💾 Backup Data</a>
                        <a href="#" id="restore-data-button" class="block px-4 py-2 text-gray-800 hover:bg-yellow-500 hover:text-white">📦 Restore Data</a>
                        <hr class="my-1 border-gray-200">
                        <a href="#" id="delete-all-data-button" class="block px-4 py-2 text-gray-800 hover:bg-red-600 hover:text-white">🗑️ Hapus Semua Data</a>
                    </div>
                </div>

                <!-- Dropdown untuk Ekspor -->
                <div class="relative dropdown-container">
                    <button class="bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 btn-animation w-full md:w-auto dropdown-btn">
                        Ekspor Produk
                    </button>
                    <div class="dropdown-menu absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl">
                        <a href="#" id="export-pdf-button" class="block px-4 py-2 text-gray-800 hover:bg-gray-600 hover:text-white">📄 Ekspor PDF Produk</a>
                        <a href="#" id="export-xlsx-button" class="block px-4 py-2 text-gray-800 hover:bg-green-700 hover:text-white">📊 Ekspor XLSX Produk</a>
                    </div>
                </div>
            </div>

            <!-- Input Pencarian -->
            <div class="mb-6">
                <input type="text" id="search-input" placeholder="Cari berdasarkan nama atau kode produk..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <!-- Bagian Tampilan Daftar Stok -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Daftar Stok</h2>
                
                <!-- Tombol Hapus Produk Terpilih -->
                <button id="delete-selected-button"
                    class="mb-4 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 btn-animation hidden">
                    🗑️ Hapus Produk Terpilih
                </button>

                <div class="overflow-x-auto rounded-lg shadow-inner">
                    <table class="w-full text-left whitespace-nowrap bg-gray-50">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-center">
                                    <input type="checkbox" id="select-all">
                                </th>
                                <th class="py-3 px-6 text-left">Nama Produk</th>
                                <th class="py-3 px-6 text-left">Kode Produk</th>
                                <th class="py-3 px-6 text-left">Foto Produk</th>
                                <th class="py-3 px-6 text-left">Stok Saat Ini</th>
                                <th class="py-3 px-6 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="stock-list" class="text-gray-600 text-sm font-light">
                            <!-- Data akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Kontrol Paginasi -->
            <div id="pagination-controls" class="flex justify-center items-center space-x-4 mt-6">
                <button id="prev-page-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 btn-animation disabled:opacity-50 disabled:cursor-not-allowed">
                    Sebelumnya
                </button>
                <span id="page-info" class="text-gray-700 font-medium">Halaman 1 dari 1</span>
                <button id="next-page-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 btn-animation disabled:opacity-50 disabled:cursor-not-allowed">
                    Berikutnya
                </button>
            </div>
            
            <!-- Elemen input file tersembunyi untuk impor data -->
            <input type="file" id="import-file-input" accept=".json" class="hidden">

        </div>

        <!-- Bagian Baru untuk Riwayat Transaksi -->
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl mt-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold text-gray-700 md:self-start">Riwayat Transaksi Stok</h2>
                <div class="flex gap-4">
                    <button id="export-history-pdf-button" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 btn-animation">
                        📄 Ekspor PDF
                    </button>
                    <button id="export-history-xlsx-button" class="bg-green-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-800 btn-animation">
                        📊 Ekspor XLSX
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-inner">
                <table class="w-full text-left whitespace-nowrap bg-gray-50">
                    <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <tr>
                            <th class="py-3 px-6 text-left">Tanggal</th>
                            <th class="py-3 px-6 text-left">Nama Produk</th>
                            <th class="py-3 px-6 text-left">Kode Produk</th>
                            <th class="py-3 px-6 text-left">Tipe</th>
                            <th class="py-3 px-6 text-left">Jumlah</th>
                            <th class="py-3 px-6 text-left">Sisa Stok</th>
                            <th class="py-3 px-6 text-left">Catatan</th>
                        </tr>
                    </thead>
                    <tbody id="history-list" class="text-gray-600 text-sm font-light">
                        <!-- Riwayat transaksi akan dimasukkan di sini oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Menginisialisasi referensi DOM
        const form = document.getElementById('stock-form');
        const itemNameInput = document.getElementById('item-name');
        const itemCodeInput = document.getElementById('item-code');
        const itemPhotoFileInput = document.getElementById('item-photo-file');
        const itemPhotoDataInput = document.getElementById('item-photo-data');
        const itemPhotoPreview = document.getElementById('item-photo-preview');
        const itemIdInput = document.getElementById('item-id');
        const stockList = document.getElementById('stock-list');
        const modalTitle = document.getElementById('modal-title');
        const formButton = document.getElementById('form-button');
        
        // Referensi untuk fitur pop-up
        const itemModal = document.getElementById('item-modal');
        const showAddModalButton = document.getElementById('show-add-modal-button');
        const closeItemModalButton = document.getElementById('close-item-modal');

        // Referensi untuk fitur Ekspor/Backup
        const backupDataButton = document.getElementById('backup-data-button');
        const exportPdfButton = document.getElementById('export-pdf-button');
        const exportXlsxButton = document.getElementById('export-xlsx-button');
        const exportHistoryPdfButton = document.getElementById('export-history-pdf-button');
        const exportHistoryXlsxButton = document.getElementById('export-history-xlsx-button');

        // Referensi untuk fitur Impor/Restore
        const restoreDataButton = document.getElementById('restore-data-button');
        const importFileInput = document.getElementById('import-file-input');

        // Referensi untuk fitur Tambah Stok baru
        const showAddStockModalButton = document.getElementById('show-add-stock-modal-button');
        const stockModal = document.getElementById('stock-modal');
        const closeStockModalButton = document.getElementById('close-stock-modal');
        const addStockForm = document.getElementById('add-stock-form');
        const stockProductSelect = document.getElementById('stock-product');
        const stockDateInput = document.getElementById('stock-date');
        const stockQuantityInput = document.getElementById('stock-quantity');
        const stockNotesInput = document.getElementById('stock-notes'); // NEW

        // Referensi untuk fitur Stok Keluar baru
        const showOutStockModalButton = document.getElementById('show-out-stock-modal-button');
        const outStockModal = document.getElementById('out-stock-modal');
        const closeOutStockModalButton = document.getElementById('close-out-stock-modal');
        const outStockForm = document.getElementById('out-stock-form');
        const outStockProductSelect = document.getElementById('out-stock-product');
        const outStockDateInput = document.getElementById('out-stock-date');
        const outStockQuantityInput = document.getElementById('out-stock-quantity');
        const outStockNotesInput = document.getElementById('out-stock-notes'); // NEW
        
        // Referensi untuk modal konfirmasi hapus massal baru
        const confirmDeleteSelectedModal = document.getElementById('confirm-delete-selected-modal');
        const confirmDeleteSelectedBtn = document.getElementById('confirm-delete-selected-btn');
        const cancelDeleteSelectedBtn = document.getElementById('cancel-delete-selected-btn');
        const deleteSelectedButton = document.getElementById('delete-selected-button');
        const selectAllCheckbox = document.getElementById('select-all');

        // Referensi untuk fitur pencarian
        const searchInput = document.getElementById('search-input');

        // Referensi Paginasi
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfoSpan = document.getElementById('page-info');

        // Referensi untuk Riwayat Transaksi
        const historyList = document.getElementById('history-list');

        // Referensi untuk Opname Stok
        const showOpnameModalButton = document.getElementById('show-opname-modal-button');
        const opnameModal = document.getElementById('opname-modal');
        const closeOpnameModalButton = document.getElementById('close-opname-modal');
        const opnameForm = document.getElementById('opname-form');
        const opnameProductSelect = document.getElementById('opname-product');
        const opnamePhysicalCountInput = document.getElementById('opname-physical-count');
        const opnameNotesInput = document.getElementById('opname-notes'); // NEW

        // REFERENSI BARU: HAPUS SEMUA DATA
        const deleteAllDataButton = document.getElementById('delete-all-data-button');
        const confirmDeleteAllModal = document.getElementById('confirm-delete-all-modal');
        const confirmDeleteAllBtn = document.getElementById('confirm-delete-all-btn');
        const cancelDeleteAllBtn = document.getElementById('cancel-delete-all-btn');


        const STORAGE_KEY = 'stok-opname-data';
        const HISTORY_KEY = 'stok-opname-history'; // Kunci baru untuk riwayat
        let stockData = [];
        let historyData = []; // Array baru untuk menyimpan riwayat
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredData = [];
        const LOW_STOCK_THRESHOLD = 20; // Batas stok minimum yang otomatis

        // Fungsi terpusat untuk menampilkan atau menyembunyikan modal
        function toggleModal(modal, show) {
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // Fungsi untuk menampilkan modal form produk
        function showItemModal() {
            toggleModal(itemModal, true);
        }

        // Fungsi untuk menyembunyikan modal form produk
        function hideItemModal() {
            toggleModal(itemModal, false);
            form.reset(); // Reset form saat modal ditutup
            itemIdInput.value = ''; // Reset ID
            modalTitle.textContent = 'Tambah Produk'; // Kembalikan judul
            formButton.textContent = 'Simpan'; // Kembalikan teks tombol
            itemPhotoPreview.classList.add('hidden'); // Sembunyikan pratinjau foto
            itemPhotoDataInput.value = ''; // Hapus data URI dari input tersembunyi
            itemPhotoFileInput.value = ''; // Reset input file
        }

        // Fungsi untuk menampilkan modal tambah stok
        function showStockModal() {
            // Isi dropdown produk sebelum menampilkan modal
            populateProductDropdown(stockProductSelect);
            // Atur tanggal hari ini secara default
            stockDateInput.valueAsDate = new Date();
            stockNotesInput.value = ''; // Reset catatan
            toggleModal(stockModal, true);
        }
        
        // Fungsi untuk menyembunyikan modal tambah stok
        function hideStockModal() {
            toggleModal(stockModal, false);
            addStockForm.reset(); // Reset form
        }

        // Fungsi untuk menampilkan modal stok keluar
        function showOutStockModal() {
             // Isi dropdown produk sebelum menampilkan modal
            populateProductDropdown(outStockProductSelect);
            // Atur tanggal hari ini secara default
            outStockDateInput.valueAsDate = new Date();
            outStockNotesInput.value = ''; // Reset catatan
            toggleModal(outStockModal, true);
        }
        
        // Fungsi untuk menyembunyikan modal stok keluar
        function hideOutStockModal() {
            toggleModal(outStockModal, false);
            outStockForm.reset(); // Reset form
        }

        // FUNGSI BARU: MENAMPILKAN MODAL OPNAME
        function showOpnameModal() {
            populateProductDropdown(opnameProductSelect);
            opnamePhysicalCountInput.value = '';
            opnameNotesInput.value = ''; // Reset catatan
            toggleModal(opnameModal, true);
        }
        
        // FUNGSI BARU: MENYEMBUNYIKAN MODAL OPNAME
        function hideOpnameModal() {
            toggleModal(opnameModal, false);
            opnameForm.reset();
        }

        // Mengisi dropdown produk di modal
        function populateProductDropdown(selectElement) {
            selectElement.innerHTML = '<option value="">-- Pilih Produk --</option>';
            stockData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name}${item.code ? ' - ' + item.code : ''}`;
                selectElement.appendChild(option);
            });
        }

        // Memuat data dari localStorage saat aplikasi dimulai
        function loadData() {
            const stockDataJson = localStorage.getItem(STORAGE_KEY);
            if (stockDataJson) {
                stockData = JSON.parse(stockDataJson);
                // Menambahkan properti 'stock' jika belum ada
                stockData.forEach(item => {
                    if (!item.stock) {
                        item.stock = 0;
                    }
                });
            }
            const historyDataJson = localStorage.getItem(HISTORY_KEY);
            if (historyDataJson) {
                const loadedHistory = JSON.parse(historyDataJson);
                // Tambahkan fallback untuk data riwayat yang lebih lama tanpa kode produk dan sisa stok
                historyData = loadedHistory.map(item => ({
                    ...item,
                    productCode: item.productCode || '-',
                    remainingStock: item.remainingStock || 0
                }));
            }
            filteredData = [...stockData]; // Inisialisasi data yang difilter
            renderData(); // Render data awal
            renderHistory(); // Render riwayat
        }

        // Menyimpan data ke localStorage
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(stockData));
        }

        // Menyimpan riwayat ke localStorage
        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
        }

        // Merender data di tabel
        function renderData() {
            stockList.innerHTML = '';
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToRender = filteredData.slice(startIndex, endIndex);

            pageInfoSpan.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

            if (itemsToRender.length === 0) {
                stockList.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-gray-500">Tidak ada produk yang tersimpan.</td></tr>`;
                deleteSelectedButton.classList.add('hidden');
                selectAllCheckbox.checked = false;
                return;
            }
            deleteSelectedButton.classList.remove('hidden');

            itemsToRender.forEach(item => {
                const row = document.createElement('tr');
                
                // Cek jika stok saat ini di bawah LOW_STOCK_THRESHOLD (20)
                if (item.stock < LOW_STOCK_THRESHOLD) {
                    row.classList.add('bg-yellow-200', 'text-yellow-800', 'hover:!bg-yellow-300');
                } else {
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                }

                const photoHtml = item.photo ? `<img src="${item.photo}" alt="Foto Produk" class="max-w-[100px] max-h-[100px] object-contain mx-auto rounded">` : `-`;
                
                row.innerHTML = `
                    <td class="py-3 px-6 text-center">
                        <input type="checkbox" class="product-checkbox" data-id="${item.id}">
                    </td>
                    <td class="py-3 px-6">${item.name}</td>
                    <td class="py-3 px-6">${item.code || '-'}</td>
                    <td class="py-3 px-6 text-center">${photoHtml}</td>
                    <td class="py-3 px-6 font-semibold">${item.stock || '0'}</td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center space-x-2">
                            <button onclick="window.editItem('${item.id}', '${item.name}', '${item.code || ''}', '${item.photo || ''}')"
                                    class="bg-blue-500 text-white text-sm py-1 px-3 rounded-md hover:bg-blue-600 btn-animation">
                                Edit
                            </button>
                        </div>
                    </td>
                `;
                stockList.appendChild(row);
            });
        }
        
        // Merender riwayat transaksi
        function renderHistory() {
            historyList.innerHTML = '';
            if (historyData.length === 0) {
                historyList.innerHTML = `<tr><td colspan="7" class="py-8 text-center text-gray-500">Belum ada riwayat transaksi.</td></tr>`;
                return;
            }
            
            historyData.sort((a, b) => new Date(b.date) - new Date(a.date)); // Urutkan dari yang terbaru
            
            historyData.forEach(transaction => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                
                let typeClass = '';
                let quantityText = transaction.quantity;
                if (transaction.type === 'Masuk') {
                    typeClass = 'text-green-600';
                } else if (transaction.type === 'Keluar') {
                    typeClass = 'text-red-600';
                } else if (transaction.type === 'Opname') {
                    typeClass = 'text-orange-600';
                    quantityText = transaction.quantity > 0 ? `+${transaction.quantity}` : transaction.quantity;
                }

                row.innerHTML = `
                    <td class="py-3 px-6">${transaction.date}</td>
                    <td class="py-3 px-6">${transaction.productName}</td>
                    <td class="py-3 px-6">${transaction.productCode || '-'}</td>
                    <td class="py-3 px-6 font-semibold ${typeClass}">${transaction.type}</td>
                    <td class="py-3 px-6">${quantityText}</td>
                    <td class="py-3 px-6">${transaction.remainingStock || 0}</td>
                    <td class="py-3 px-6 text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap">${transaction.notes || '-'}</td>
                `;
                historyList.appendChild(row);
            });
        }

        // Fungsi untuk menambahkan transaksi ke riwayat
        function addTransaction(productId, productName, productCode, quantity, type, date, remainingStock, notes) {
            const newTransaction = {
                id: crypto.randomUUID(),
                productId,
                productName,
                productCode,
                quantity,
                type,
                date,
                remainingStock, // Tambahkan sisa stok
                notes // NEW: Tambahkan catatan
            };
            historyData.push(newTransaction);
            saveHistory();
            renderHistory();
        }


        // Listener untuk file input, mengkonversi file menjadi data URI
        itemPhotoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    itemPhotoDataInput.value = e.target.result; // Simpan data URI
                    itemPhotoPreview.src = e.target.result; // Tampilkan pratinjau
                    itemPhotoPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Fungsi untuk menambahkan atau mengupdate produk
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const id = itemIdInput.value;
            const name = itemNameInput.value.trim();
            const code = itemCodeInput.value.trim();
            const photoData = itemPhotoDataInput.value;
            
            if (!name) {
                console.error("Nama produk tidak valid.");
                return;
            }

            // Tutup modal form produk terlebih dahulu
            hideItemModal();

            if (id) {
                // Mode Edit
                const index = stockData.findIndex(item => item.id === id);
                if (index > -1) {
                    stockData[index].name = name;
                    stockData[index].code = code;
                    stockData[index].photo = photoData;
                }
            } else {
                // Mode Tambah
                const newItem = {
                    id: crypto.randomUUID(),
                    name: name,
                    code: code,
                    photo: photoData,
                    stock: 0 // Inisialisasi stok menjadi 0
                };
                stockData.push(newItem);
            }
            saveData();
            // Perbarui data yang difilter dan render ulang
            filteredData = [...stockData];
            renderData();
        });

        // Fungsi untuk mengisi form saat tombol edit diklik
        window.editItem = function(id, name, code, photo) {
            itemIdInput.value = id;
            itemNameInput.value = name;
            itemCodeInput.value = code;
            itemPhotoDataInput.value = photo; // Set data URI untuk edit
            if (photo) {
                itemPhotoPreview.src = photo;
                itemPhotoPreview.classList.remove('hidden');
            } else {
                itemPhotoPreview.classList.add('hidden');
            }
            // Catatan: File input tidak bisa diisi secara terprogram karena alasan keamanan
            
            modalTitle.textContent = 'Edit Produk';
            formButton.textContent = 'Update';
            showItemModal();
        };


        // ==========================================
        // FITUR HAPUS PRODUK TERPILIH
        // ==========================================
        // Listener untuk tombol "Hapus Produk Terpilih"
        deleteSelectedButton.addEventListener('click', () => {
            const selectedItems = Array.from(document.querySelectorAll('.product-checkbox:checked'));
            if (selectedItems.length > 0) {
                toggleModal(confirmDeleteSelectedModal, true);
            }
        });

        // Listener untuk tombol "Hapus" pada modal konfirmasi hapus massal
        confirmDeleteSelectedBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.id);
            stockData = stockData.filter(item => !selectedIds.includes(item.id));
            saveData();
            // Perbarui data yang difilter dan render ulang
            filteredData = [...stockData];
            renderData();
            toggleModal(confirmDeleteSelectedModal, false);
        });

        // Listener untuk tombol "Batal" pada modal konfirmasi hapus massal
        cancelDeleteSelectedBtn.addEventListener('click', () => {
            toggleModal(confirmDeleteSelectedModal, false);
        });
        
        // Listener untuk checkbox "Pilih Semua"
        selectAllCheckbox.addEventListener('change', (event) => {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        });

        // ==========================================
        // FITUR BACKUP DAN RESTORE DATA
        // ==========================================
        
        // Listener untuk tombol Backup, mengunduh file secara langsung
        backupDataButton.addEventListener('click', () => {
            const dataToExport = JSON.stringify({ stock: stockData, history: historyData }, null, 2);
            if (!dataToExport || dataToExport === '[]') {
                console.error("Tidak ada data untuk di-backup.");
                return;
            }

            // Membuat Blob dari data JSON
            const blob = new Blob([dataToExport], { type: 'application/json' });
            // Membuat URL objek dari Blob
            const url = URL.createObjectURL(blob);
            
            // Membuat elemen link sementara untuk mengunduh
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stok_opname_backup.json'; // Nama file yang akan diunduh
            document.body.appendChild(a);
            a.click();
            
            // Membersihkan URL objek dan elemen link
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Listener untuk tombol "Restore Data", yang sekarang mengklik input file tersembunyi
        restoreDataButton.addEventListener('click', (e) => {
            e.preventDefault(); // Mencegah navigasi default link
            importFileInput.click();
        });

        // Listener untuk input file, membaca dan memproses file yang dipilih
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && importedData.stock && importedData.history) {
                        stockData = importedData.stock;
                        historyData = importedData.history;
                        saveData();
                        saveHistory();
                        // Perbarui data yang difilter dan render ulang
                        filteredData = [...stockData];
                        renderData();
                        renderHistory();
                        console.log("Data berhasil di-restore!");
                        setTimeout(() => window.location.reload(), 500); // Segarkan halaman untuk memastikan data baru dimuat
                    } else {
                        console.error("Data yang diimpor tidak valid. Pastikan itu adalah file backup dari aplikasi ini.");
                    }
                } catch (error) {
                    console.error("Terjadi kesalahan saat memproses file JSON. Pastikan format file sudah benar.", error);
                }
            };
            reader.readAsText(file);
        });

        // ==========================================
        // FITUR EKSPOR PDF DAN XLSX
        // ==========================================

        // Listener untuk tombol Ekspor PDF
        exportPdfButton.addEventListener('click', (e) => {
            e.preventDefault(); // Mencegah navigasi default link
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const columns = ["Nama Produk", "Kode Produk", "Stok Saat Ini"];
            const data = filteredData.map(item => [item.name, item.code || '-', item.stock || 0]);

            doc.autoTable({
                head: [columns],
                body: data,
                startY: 20,
                headStyles: { fillColor: [75, 85, 99] }, // Warna abu-abu gelap
                theme: 'striped',
                columnStyles: {
                    0: { cellWidth: 50 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 30 },
                }
            });

            doc.save('daftar_stok.pdf');
        });

        // Listener untuk tombol Ekspor XLSX
        exportXlsxButton.addEventListener('click', (e) => {
            e.preventDefault(); // Mencegah navigasi default link
            const data = [
                ["Nama Produk", "Kode Produk", "Stok Saat Ini"],
                ...filteredData.map(item => [item.name, item.code || '-', item.stock || 0])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Stok Opname");
            XLSX.writeFile(wb, "daftar_stok.xlsx");
        });

        // Listener untuk tombol Ekspor Riwayat PDF
        exportHistoryPdfButton.addEventListener('click', (e) => {
            e.preventDefault(); // Mencegah navigasi default link
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const columns = ["Tanggal", "Nama Produk", "Kode Produk", "Tipe", "Jumlah", "Sisa Stok", "Catatan"];
            const data = historyData.map(t => [t.date, t.productName, t.productCode || '-', t.type, t.quantity, t.remainingStock || 0, t.notes || '-']);
            
            doc.autoTable({
                head: [columns],
                body: data,
                startY: 20,
                headStyles: { fillColor: [75, 85, 99] }, // Warna abu-abu gelap
                theme: 'striped',
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 15 },
                    5: { cellWidth: 20 },
                    6: { cellWidth: 35 }
                }
            });

            doc.save('riwayat_stok.pdf');
        });

        // Listener untuk tombol Ekspor Riwayat XLSX
        exportHistoryXlsxButton.addEventListener('click', (e) => {
            e.preventDefault(); // Mencegah navigasi default link
            const data = [
                ["Tanggal", "Nama Produk", "Kode Produk", "Tipe", "Jumlah", "Sisa Stok", "Catatan"],
                ...historyData.map(t => [t.date, t.productName, t.productCode || '-', t.type, t.quantity, t.remainingStock || 0, t.notes || '-'])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Riwayat Stok");
            XLSX.writeFile(wb, "riwayat_stok.xlsx");
        });


        // ==========================================
        // FITUR POP-UP
        // ==========================================
        showAddModalButton.addEventListener('click', () => {
            hideItemModal(); // Pastikan form bersih saat membuka modal baru
            modalTitle.textContent = 'Tambah Produk';
            formButton.textContent = 'Simpan';
            showItemModal();
        });

        // Listener untuk tombol menutup modal item
        closeItemModalButton.addEventListener('click', hideItemModal);

        // Listener untuk menutup modal saat mengklik di luar konten
        itemModal.addEventListener('click', (event) => {
            if (event.target === itemModal) {
                hideItemModal();
            }
        });

        // ==========================================
        // LOGIKA TAMBAH STOK BARU
        // ==========================================
        
        // Listener untuk tombol "Tambah Stok"
        showAddStockModalButton.addEventListener('click', (e) => {
            e.preventDefault();
            showStockModal();
        });

        // Listener untuk tombol menutup modal stok
        closeStockModalButton.addEventListener('click', hideStockModal);

        // Listener untuk menutup modal stok saat mengklik di luar konten
        stockModal.addEventListener('click', (event) => {
            if (event.target === stockModal) {
                hideStockModal();
            }
        });

        addStockForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const productId = stockProductSelect.value;
            const quantity = parseInt(stockQuantityInput.value, 10);
            const date = stockDateInput.value;
            const notes = stockNotesInput.value.trim();
            
            const product = stockData.find(item => item.id === productId);
            if (product) {
                product.stock += quantity;
                addTransaction(product.id, product.name, product.code, quantity, 'Masuk', date, product.stock, notes);
                saveData();
                filteredData = [...stockData];
                renderData();
                hideStockModal();
            } else {
                console.error("Produk tidak ditemukan.");
            }
        });

        // ==========================================
        // LOGIKA STOK KELUAR
        // ==========================================

        // Listener untuk tombol "Stok Keluar"
        showOutStockModalButton.addEventListener('click', (e) => {
            e.preventDefault();
            showOutStockModal();
        });

        // Listener untuk tombol menutup modal stok keluar
        closeOutStockModalButton.addEventListener('click', hideOutStockModal);

        // Listener untuk menutup modal stok keluar saat mengklik di luar konten
        outStockModal.addEventListener('click', (event) => {
            if (event.target === outStockModal) {
                hideOutStockModal();
            }
        });

        outStockForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const productId = outStockProductSelect.value;
            const quantity = parseInt(outStockQuantityInput.value, 10);
            const date = outStockDateInput.value;
            const notes = outStockNotesInput.value.trim();
            
            const product = stockData.find(item => item.id === productId);
            if (product && product.stock >= quantity) {
                product.stock -= quantity;
                addTransaction(product.id, product.name, product.code, -quantity, 'Keluar', date, product.stock, notes);
                saveData();
                filteredData = [...stockData];
                renderData();
                hideOutStockModal();
            } else {
                console.error("Jumlah stok tidak mencukupi.");
            }
        });

        // ==========================================
        // LOGIKA OPNAME STOK
        // ==========================================
        
        // Listener untuk tombol "Opname Stok"
        showOpnameModalButton.addEventListener('click', (e) => {
            e.preventDefault();
            showOpnameModal();
        });

        // Listener untuk tombol menutup modal opname
        closeOpnameModalButton.addEventListener('click', hideOpnameModal);

        // Listener untuk menutup modal opname saat mengklik di luar
        opnameModal.addEventListener('click', (event) => {
            if (event.target === opnameModal) {
                hideOpnameModal();
            }
        });

        opnameForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const productId = opnameProductSelect.value;
            const physicalCount = parseInt(opnamePhysicalCountInput.value, 10);
            const notes = opnameNotesInput.value.trim();
            
            const product = stockData.find(item => item.id === productId);
            if (product) {
                const difference = physicalCount - product.stock;
                product.stock = physicalCount;
                addTransaction(product.id, product.name, product.code, difference, 'Opname', new Date().toISOString().slice(0, 10), product.stock, notes);
                saveData();
                filteredData = [...stockData];
                renderData();
                hideOpnameModal();
            } else {
                console.error("Produk tidak ditemukan.");
            }
        });
        
        // ==========================================
        // LOGIKA PENCARIAN
        // ==========================================
        
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase().trim();
            filteredData = stockData.filter(item => 
                item.name.toLowerCase().includes(query) ||
                (item.code && item.code.toLowerCase().includes(query))
            );
            currentPage = 1;
            renderData();
        });


        // ==========================================
        // LOGIKA PAGINASI
        // ==========================================

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderData();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderData();
            }
        });

        // FUNGSI BARU: HAPUS SEMUA DATA
        function clearAllData() {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(HISTORY_KEY);
            stockData = [];
            historyData = [];
            filteredData = [];
            renderData();
            renderHistory();
        }

        // Event listener untuk tombol Hapus Semua Data
        deleteAllDataButton.addEventListener('click', (e) => {
            e.preventDefault();
            toggleModal(confirmDeleteAllModal, true);
        });

        confirmDeleteAllBtn.addEventListener('click', () => {
            clearAllData();
            toggleModal(confirmDeleteAllModal, false);
            // Segarkan halaman untuk memastikan data baru dimuat dan UI bersih
            setTimeout(() => window.location.reload(), 500); 
        });

        cancelDeleteAllBtn.addEventListener('click', () => {
            toggleModal(confirmDeleteAllModal, false);
        });
        
        // ==========================================
        // LOGIKA DROPDOWN CLICK
        // ==========================================

        const dropdownButtons = document.querySelectorAll('.dropdown-btn');
        const dropdownContainers = document.querySelectorAll('.dropdown-container');

        // Menutup semua dropdown yang terbuka
        function closeAllDropdowns() {
            dropdownContainers.forEach(container => {
                const menu = container.querySelector('.dropdown-menu');
                menu.classList.remove('dropdown-menu-active');
            });
        }

        // Event listener untuk setiap tombol dropdown
        dropdownButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Mencegah event dari mencapai body
                
                // Tutup semua dropdown lain
                dropdownContainers.forEach(container => {
                    const menu = container.querySelector('.dropdown-menu');
                    // Kecuali menu yang baru saja diklik
                    if (container.contains(e.target)) {
                        menu.classList.toggle('dropdown-menu-active');
                    } else {
                        menu.classList.remove('dropdown-menu-active');
                    }
                });
            });
        });

        // Event listener untuk menutup dropdown saat mengklik di mana saja di luar area dropdown
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-container')) {
                closeAllDropdowns();
            }
        });


        // Memuat data awal saat halaman dimuat
        document.addEventListener('DOMContentLoaded', loadData);
    </script>

</body>
</html>
