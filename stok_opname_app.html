<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Stok Opname</title>
    <!-- Tailwind CSS CDN untuk styling yang cepat dan modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles untuk animasi tombol */
        .btn-animation {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .btn-animation:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-animation:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Styling untuk modal pop-up */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal-container:not(.active) .modal-content {
            transform: translateY(-50px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Modal Form Tambah/Edit Produk -->
    <div id="item-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-semibold text-gray-700">Tambah Produk</h2>
                <button id="close-item-modal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            </div>
            
            <!-- Tambahkan div yang bisa di-scroll di sini -->
            <div class="overflow-y-auto max-h-[70vh] pr-2">
                <form id="stock-form">
                    <input type="hidden" id="item-id">
                    <div class="space-y-4">
                        <!-- Input Nama Produk -->
                        <div class="flex flex-col">
                            <label for="item-name" class="text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
                            <input type="text" id="item-name" placeholder="Nama Produk" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <!-- Input Kode Produk -->
                        <div class="flex flex-col">
                            <label for="item-code" class="text-sm font-medium text-gray-700 mb-1">Kode Produk</label>
                            <input type="text" id="item-code" placeholder="Kode Produk"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>

                        <!-- Input Foto Produk dengan tipe file -->
                        <div class="flex flex-col">
                            <label for="item-photo-file" class="text-sm font-medium text-gray-700 mb-1">Pilih Foto Produk</label>
                            <input type="file" id="item-photo-file" accept="image/*"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Input tersembunyi untuk menyimpan data URI foto -->
                            <input type="hidden" id="item-photo-data">
                            <!-- Pratinjau Foto -->
                            <img id="item-photo-preview" src="#" alt="Pratinjau Foto" class="mt-2 hidden rounded-lg max-w-[100px] max-h-[100px] object-contain">
                        </div>

                        <!-- Input Stok Minimum -->
                        <div class="flex flex-col">
                            <label for="item-min-stock" class="text-sm font-medium text-gray-700 mb-1">Stok Minimum</label>
                            <input type="number" id="item-min-stock" placeholder="Stok Minimum"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </form>
            </div>

            <div class="grid grid-cols-1 gap-4 mt-6">
                <!-- Tombol Simpan kembali ke dalam grid tanpa tombol buat deskripsi -->
                <button type="submit" id="form-button" form="stock-form"
                    class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 btn-animation">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Form Tambah Stok -->
    <div id="stock-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Tambah Stok</h2>
                <button id="close-stock-modal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            </div>
            <form id="add-stock-form">
                <div class="space-y-4">
                    <!-- Dropdown Produk -->
                    <div class="flex flex-col">
                        <label for="stock-product" class="text-sm font-medium text-gray-700 mb-1">Pilih Produk</label>
                        <select id="stock-product" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Pilih Produk --</option>
                        </select>
                    </div>
                    <!-- Input Tanggal -->
                    <div class="flex flex-col">
                        <label for="stock-date" class="text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="stock-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Input Jumlah Stok -->
                    <div class="flex flex-col">
                        <label for="stock-quantity" class="text-sm font-medium text-gray-700 mb-1">Jumlah Stok</label>
                        <input type="number" id="stock-quantity" placeholder="Masukkan jumlah stok" required min="1"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 btn-animation">
                        Simpan Stok
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-sm">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Konfirmasi Hapus</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus produk ini?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 btn-animation">
                    Batal
                </button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 btn-animation">
                    Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- Halaman utama aplikasi -->
    <div class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Aplikasi Stok Opname</h1>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <button id="show-add-modal-button"
                        class="w-full md:w-auto bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 btn-animation">
                    âž• Tambah Produk
                </button>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="show-add-stock-modal-button"
                            class="w-full md:w-auto bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 btn-animation">
                        ðŸ“¦ Tambah Stok
                    </button>
                    <button id="export-button"
                            class="w-full md:w-auto bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 btn-animation">
                        ðŸ’¾ Ekspor Data
                    </button>
                    <button id="show-import-button"
                            class="w-full md:w-auto bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 btn-animation">
                        ðŸ“¦ Impor Data
                    </button>
                </div>
            </div>

            <!-- Bagian Tampilan Daftar Stok -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Daftar Stok</h2>
                <div class="overflow-x-auto rounded-lg shadow-inner">
                    <table class="w-full text-left whitespace-nowrap bg-gray-50">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Nama Produk</th>
                                <th class="py-3 px-6 text-left">Kode Produk</th>
                                <th class="py-3 px-6 text-left">Foto Produk</th>
                                <th class="py-3 px-6 text-left">Stok Minimum</th>
                                <th class="py-3 px-6 text-left">Stok Saat Ini</th>
                                <th class="py-3 px-6 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="stock-list" class="text-gray-600 text-sm font-light">
                            <!-- Data akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Elemen input file tersembunyi untuk impor data -->
            <input type="file" id="import-file-input" accept=".json" class="hidden">

        </div>
    </div>
    
    <script type="module">
        // Menginisialisasi referensi DOM
        const form = document.getElementById('stock-form');
        const itemNameInput = document.getElementById('item-name');
        const itemCodeInput = document.getElementById('item-code');
        const itemPhotoFileInput = document.getElementById('item-photo-file');
        const itemPhotoDataInput = document.getElementById('item-photo-data');
        const itemPhotoPreview = document.getElementById('item-photo-preview');
        const itemMinStockInput = document.getElementById('item-min-stock');
        const itemIdInput = document.getElementById('item-id');
        const stockList = document.getElementById('stock-list');
        const modalTitle = document.getElementById('modal-title');
        const formButton = document.getElementById('form-button');
        
        // Referensi untuk fitur pop-up
        const itemModal = document.getElementById('item-modal');
        const showAddModalButton = document.getElementById('show-add-modal-button');
        const closeItemModalButton = document.getElementById('close-item-modal');

        // Referensi untuk fitur Ekspor
        const exportButton = document.getElementById('export-button');

        // Referensi untuk fitur Impor baru
        const showImportButton = document.getElementById('show-import-button');
        const importFileInput = document.getElementById('import-file-input');

        // Referensi untuk fitur Tambah Stok baru
        const showAddStockModalButton = document.getElementById('show-add-stock-modal-button');
        const stockModal = document.getElementById('stock-modal');
        const closeStockModalButton = document.getElementById('close-stock-modal');
        const addStockForm = document.getElementById('add-stock-form');
        const stockProductSelect = document.getElementById('stock-product');
        const stockDateInput = document.getElementById('stock-date');
        const stockQuantityInput = document.getElementById('stock-quantity');
        
        // Referensi untuk modal konfirmasi hapus baru
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        const STORAGE_KEY = 'stok-opname-data';
        let stockData = [];
        let itemToDeleteId = null; // Menyimpan ID produk yang akan dihapus

        // Fungsi terpusat untuk menampilkan atau menyembunyikan modal
        function toggleModal(modal, show) {
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // Fungsi untuk menampilkan modal form produk
        function showItemModal() {
            toggleModal(itemModal, true);
        }

        // Fungsi untuk menyembunyikan modal form produk
        function hideItemModal() {
            toggleModal(itemModal, false);
            form.reset(); // Reset form saat modal ditutup
            itemIdInput.value = ''; // Reset ID
            modalTitle.textContent = 'Tambah Produk'; // Kembalikan judul
            formButton.textContent = 'Simpan'; // Kembalikan teks tombol
            itemPhotoPreview.classList.add('hidden'); // Sembunyikan pratinjau foto
            itemPhotoDataInput.value = ''; // Hapus data URI dari input tersembunyi
        }

        // Fungsi untuk menampilkan modal tambah stok
        function showStockModal() {
            // Isi dropdown produk sebelum menampilkan modal
            populateProductDropdown();
            // Atur tanggal hari ini secara default
            stockDateInput.valueAsDate = new Date();
            toggleModal(stockModal, true);
        }
        
        // Fungsi untuk menyembunyikan modal tambah stok
        function hideStockModal() {
            toggleModal(stockModal, false);
            addStockForm.reset(); // Reset form
        }

        // Mengisi dropdown produk di modal tambah stok
        function populateProductDropdown() {
            stockProductSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';
            stockData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name}${item.code ? ' - ' + item.code : ''}`;
                stockProductSelect.appendChild(option);
            });
        }

        // Memuat data dari localStorage saat aplikasi dimulai
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                stockData = JSON.parse(data);
                // Menambahkan properti 'stock' jika belum ada
                stockData.forEach(item => {
                    if (!item.stock) {
                        item.stock = 0;
                    }
                });
            }
            renderData();
        }

        // Menyimpan data ke localStorage
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(stockData));
        }

        // Merender data di tabel
        function renderData() {
            stockList.innerHTML = '';
            if (stockData.length === 0) {
                // Kolom berubah menjadi 6: Nama, Kode, Foto, Stok Minimum, Stok Saat Ini, Aksi
                stockList.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-gray-500">Tidak ada produk yang tersimpan.</td></tr>`;
                return;
            }
            stockData.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                // Membuat elemen img dengan ukuran maksimal 100px dan mempertahankan aspek rasio
                const photoHtml = item.photo ? `<img src="${item.photo}" alt="Foto Produk" class="max-w-[100px] max-h-[100px] object-contain mx-auto">` : `-`;
                row.innerHTML = `
                    <td class="py-3 px-6">${item.name}</td>
                    <td class="py-3 px-6">${item.code || '-'}</td>
                    <td class="py-3 px-6 text-center">${photoHtml}</td>
                    <td class="py-3 px-6">${item.minStock || '-'}</td>
                    <td class="py-3 px-6 font-semibold">${item.stock || '0'}</td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center space-x-2">
                            <button onclick="window.editItem('${item.id}', '${item.name}', '${item.code || ''}', '${item.photo || ''}', ${item.minStock || '0'})"
                                    class="bg-blue-500 text-white text-sm py-1 px-3 rounded-md hover:bg-blue-600 btn-animation">
                                Edit
                            </button>
                            <button onclick="window.showDeleteConfirmation('${item.id}')"
                                    class="bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600 btn-animation">
                                Hapus
                            </button>
                        </div>
                    </td>
                `;
                stockList.appendChild(row);
            });
        }

        // Listener untuk file input, mengkonversi file menjadi data URI
        itemPhotoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    itemPhotoDataInput.value = e.target.result; // Simpan data URI
                    itemPhotoPreview.src = e.target.result; // Tampilkan pratinjau
                    itemPhotoPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Fungsi untuk menambahkan atau mengupdate produk
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const id = itemIdInput.value;
            const name = itemNameInput.value.trim();
            const code = itemCodeInput.value.trim();
            const photoData = itemPhotoDataInput.value;
            const minStock = parseInt(itemMinStockInput.value, 10);
            
            if (!name) {
                console.error("Nama produk tidak valid.");
                return;
            }

            // Tutup modal form produk terlebih dahulu
            hideItemModal();

            if (id) {
                // Mode Edit
                const index = stockData.findIndex(item => item.id === id);
                if (index > -1) {
                    stockData[index].name = name;
                    stockData[index].code = code;
                    stockData[index].photo = photoData;
                    stockData[index].minStock = minStock;
                }
            } else {
                // Mode Tambah
                const newItem = {
                    id: crypto.randomUUID(),
                    name: name,
                    code: code,
                    photo: photoData,
                    minStock: minStock,
                    stock: 0 // Inisialisasi stok menjadi 0
                };
                stockData.push(newItem);
            }
            saveData();
            renderData();
        });

        // Fungsi untuk mengisi form saat tombol edit diklik
        window.editItem = function(id, name, code, photo, minStock) {
            itemIdInput.value = id;
            itemNameInput.value = name;
            itemCodeInput.value = code;
            itemMinStockInput.value = minStock;
            itemPhotoDataInput.value = photo; // Set data URI untuk edit
            if (photo) {
                itemPhotoPreview.src = photo;
                itemPhotoPreview.classList.remove('hidden');
            } else {
                itemPhotoPreview.classList.add('hidden');
            }
            // Catatan: File input tidak bisa diisi secara terprogram karena alasan keamanan
            
            modalTitle.textContent = 'Edit Produk';
            formButton.textContent = 'Update';
            showItemModal();
        };

        // Fungsi untuk menunjukkan modal konfirmasi hapus
        window.showDeleteConfirmation = function(id) {
            itemToDeleteId = id; // Simpan ID produk yang akan dihapus
            toggleModal(confirmModal, true);
        };
        
        // Fungsi untuk menghapus produk setelah konfirmasi
        function deleteItem() {
            if (itemToDeleteId) {
                stockData = stockData.filter(item => item.id !== itemToDeleteId);
                saveData();
                renderData();
                itemToDeleteId = null; // Reset ID
                toggleModal(confirmModal, false); // Tutup modal
            }
        }

        // Listener untuk tombol "Hapus" pada modal konfirmasi
        confirmDeleteBtn.addEventListener('click', deleteItem);

        // Listener untuk tombol "Batal" pada modal konfirmasi
        cancelDeleteBtn.addEventListener('click', () => {
            toggleModal(confirmModal, false);
            itemToDeleteId = null; // Reset ID
        });


        // ==========================================
        // FITUR EKSPOR DAN IMPOR DATA
        // ==========================================
        
        // Listener untuk tombol Ekspor, sekarang mengunduh file secara langsung
        exportButton.addEventListener('click', () => {
            const dataToExport = localStorage.getItem(STORAGE_KEY);
            if (!dataToExport || dataToExport === '[]') {
                console.error("Tidak ada data untuk diekspor.");
                return;
            }

            // Membuat Blob dari data JSON
            const blob = new Blob([dataToExport], { type: 'application/json' });
            // Membuat URL objek dari Blob
            const url = URL.createObjectURL(blob);
            
            // Membuat elemen link sementara untuk mengunduh
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stok_opname.json'; // Nama file yang akan diunduh
            document.body.appendChild(a);
            a.click();
            
            // Membersihkan URL objek dan elemen link
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Listener untuk tombol "Impor Data", yang sekarang mengklik input file tersembunyi
        showImportButton.addEventListener('click', () => {
            importFileInput.click();
        });

        // Listener untuk input file, membaca dan memproses file yang dipilih
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        stockData = importedData;
                        saveData();
                        renderData();
                        console.log("Data berhasil diimpor!");
                        setTimeout(() => window.location.reload(), 500); // Segarkan halaman untuk memastikan data baru dimuat
                    } else {
                        console.error("Data yang diimpor tidak valid. Pastikan itu adalah array JSON.");
                    }
                } catch (error) {
                    console.error("Terjadi kesalahan saat memproses file JSON. Pastikan format file sudah benar.", error);
                }
            };
            reader.readAsText(file);
        });

        // ==========================================
        // FITUR POP-UP
        // ==========================================
        showAddModalButton.addEventListener('click', () => {
            hideItemModal(); // Pastikan form bersih saat membuka modal baru
            modalTitle.textContent = 'Tambah Produk';
            formButton.textContent = 'Simpan';
            showItemModal();
        });

        // Listener untuk tombol menutup modal item
        closeItemModalButton.addEventListener('click', hideItemModal);

        // Listener untuk menutup modal saat mengklik di luar konten
        itemModal.addEventListener('click', (event) => {
            if (event.target === itemModal) {
                hideItemModal();
            }
        });

        // ==========================================
        // LOGIKA TAMBAH STOK BARU
        // ==========================================
        
        // Listener untuk tombol "Tambah Stok"
        showAddStockModalButton.addEventListener('click', showStockModal);

        // Listener untuk tombol menutup modal stok
        closeStockModalButton.addEventListener('click', hideStockModal);

        // Listener untuk menutup modal stok saat mengklik di luar konten
        stockModal.addEventListener('click', (event) => {
            if (event.target === stockModal) {
                hideStockModal();
            }
        });

        // Listener untuk form tambah stok
        addStockForm.addEventListener('submit', (event) => {
            event.preventDefault();
            
            const productId = stockProductSelect.value;
            const quantity = parseInt(stockQuantityInput.value, 10);
            
            // Cari produk berdasarkan ID dan perbarui stoknya
            const item = stockData.find(p => p.id === productId);
            if (item) {
                item.stock += quantity;
                saveData();
                renderData();
                hideStockModal(); // Tutup modal setelah data disimpan
            } else {
                console.error("Produk tidak ditemukan.");
            }
        });

        // Memuat data saat aplikasi pertama kali dijalankan
        loadData();
    </script>
</body>
</html>
