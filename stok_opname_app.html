<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Stok Opname</title>
    <!-- Tailwind CSS CDN untuk styling yang cepat dan modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles untuk animasi tombol */
        .btn-animation {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .btn-animation:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-animation:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Styling untuk modal pop-up */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal-container:not(.active) .modal-content {
            transform: translateY(-50px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Modal untuk notifikasi pengguna, menggantikan alert() -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="modal-text" class="text-gray-800 text-lg mb-4"></p>
            <button onclick="closeModal()" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 btn-animation">
                Tutup
            </button>
        </div>
    </div>

    <!-- Modal Form Tambah/Edit Produk -->
    <div id="item-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-semibold text-gray-700">Tambah Produk</h2>
                <button id="close-item-modal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            </div>
            
            <form id="stock-form">
                <input type="hidden" id="item-id">
                <div class="space-y-4">
                    <!-- Input Nama Produk -->
                    <div class="flex flex-col">
                        <label for="item-name" class="text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
                        <input type="text" id="item-name" placeholder="Nama Produk" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    
                    <!-- Input Kode Produk -->
                    <div class="flex flex-col">
                        <label for="item-code" class="text-sm font-medium text-gray-700 mb-1">Kode Produk</label>
                        <input type="text" id="item-code" placeholder="Kode Produk"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Input Foto Produk -->
                    <div class="flex flex-col">
                        <label for="item-photo" class="text-sm font-medium text-gray-700 mb-1">URL Foto Produk</label>
                        <input type="text" id="item-photo" placeholder="http://example.com/foto.jpg"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Input Jumlah Stok -->
                    <div class="flex flex-col">
                        <label for="item-stock" class="text-sm font-medium text-gray-700 mb-1">Jumlah Stok</label>
                        <input type="number" id="item-stock" placeholder="Jumlah Stok" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Input Stok Minimum -->
                    <div class="flex flex-col">
                        <label for="item-min-stock" class="text-sm font-medium text-gray-700 mb-1">Stok Minimum</label>
                        <input type="number" id="item-min-stock" placeholder="Stok Minimum"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Input Deskripsi -->
                    <div class="flex flex-col">
                        <label for="item-description" class="text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                        <textarea id="item-description" placeholder="Deskripsi produk" rows="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <button type="button" id="generate-description-button"
                        class="w-full bg-emerald-600 text-white font-semibold py-3 rounded-lg hover:bg-emerald-700 btn-animation">
                        ‚ú® Buat Deskripsi Otomatis
                    </button>
                    <button type="submit" id="form-button"
                        class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 btn-animation">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Halaman utama aplikasi -->
    <div class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Aplikasi Stok Opname</h1>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <button id="show-add-modal-button"
                        class="w-full md:w-auto bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 btn-animation">
                    ‚ûï Tambah Produk
                </button>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="export-button"
                            class="w-full md:w-auto bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 btn-animation">
                        üíæ Ekspor Data
                    </button>
                    <button id="show-import-button"
                            class="w-full md:w-auto bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 btn-animation">
                        üì¶ Impor Data
                    </button>
                </div>
            </div>

            <!-- Bagian Tampilan Daftar Stok -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Daftar Stok</h2>
                <div class="overflow-x-auto rounded-lg shadow-inner">
                    <table class="w-full text-left whitespace-nowrap bg-gray-50">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Nama Produk</th>
                                <th class="py-3 px-6 text-left">Kode Produk</th>
                                <th class="py-3 px-6 text-left">Stok</th>
                                <th class="py-3 px-6 text-left">Stok Minimum</th>
                                <th class="py-3 px-6 text-left">Deskripsi</th>
                                <th class="py-3 px-6 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="stock-list" class="text-gray-600 text-sm font-light">
                            <!-- Data akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Bagian Impor yang Tersembunyi -->
            <div id="import-section" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-2 text-gray-700">Tempelkan Data Impor</h3>
                <textarea id="import-data" rows="5" placeholder="Tempelkan data JSON di sini..."
                    class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
                <div class="mt-4 flex gap-4">
                    <button id="import-button"
                            class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 btn-animation">
                        ‚úÖ Konfirmasi Impor
                    </button>
                    <button id="cancel-import-button"
                            class="w-full bg-gray-400 text-white font-semibold py-3 rounded-lg hover:bg-gray-500 btn-animation">
                        ‚ùå Batal
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        // Menginisialisasi referensi DOM
        const form = document.getElementById('stock-form');
        const itemNameInput = document.getElementById('item-name');
        const itemCodeInput = document.getElementById('item-code'); // Tambahan: Kode Produk
        const itemPhotoInput = document.getElementById('item-photo'); // Tambahan: Foto Produk
        const itemStockInput = document.getElementById('item-stock');
        const itemMinStockInput = document.getElementById('item-min-stock'); // Tambahan: Stok Minimum
        const itemDescriptionTextarea = document.getElementById('item-description');
        const generateDescriptionButton = document.getElementById('generate-description-button');
        const itemIdInput = document.getElementById('item-id');
        const stockList = document.getElementById('stock-list');
        const modalTitle = document.getElementById('modal-title');
        const formButton = document.getElementById('form-button');
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        
        // Referensi baru untuk fitur pop-up
        const itemModal = document.getElementById('item-modal');
        const showAddModalButton = document.getElementById('show-add-modal-button');
        const closeItemModalButton = document.getElementById('close-item-modal');

        // Referensi untuk fitur Impor/Ekspor
        const exportButton = document.getElementById('export-button');
        const showImportButton = document.getElementById('show-import-button');
        const importSection = document.getElementById('import-section');
        const importDataTextarea = document.getElementById('import-data');
        const importButton = document.getElementById('import-button');
        const cancelImportButton = document.getElementById('cancel-import-button');

        const STORAGE_KEY = 'stok-opname-data';
        let stockData = [];

        // Fungsi untuk menampilkan modal pesan
        function showModal(message) {
            modalText.textContent = message;
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        // Fungsi untuk menutup modal pesan
        function closeModal() {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
        }

        // Fungsi untuk menampilkan modal form produk
        function showItemModal() {
            itemModal.classList.remove('hidden');
            itemModal.classList.add('flex');
        }

        // Fungsi untuk menyembunyikan modal form produk
        function hideItemModal() {
            itemModal.classList.add('hidden');
            itemModal.classList.remove('flex');
            form.reset(); // Reset form saat modal ditutup
            itemIdInput.value = ''; // Reset ID
            modalTitle.textContent = 'Tambah Produk'; // Kembalikan judul
            formButton.textContent = 'Simpan'; // Kembalikan teks tombol
        }

        // Memuat data dari localStorage saat aplikasi dimulai
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                stockData = JSON.parse(data);
            }
            renderData();
        }

        // Menyimpan data ke localStorage
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(stockData));
        }

        // Merender data di tabel
        function renderData() {
            stockList.innerHTML = '';
            if (stockData.length === 0) {
                stockList.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-gray-500">Tidak ada produk yang tersimpan.</td></tr>`;
                return;
            }
            stockData.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                row.innerHTML = `
                    <td class="py-3 px-6">${item.name}</td>
                    <td class="py-3 px-6">${item.code || '-'}</td>
                    <td class="py-3 px-6">${item.stock}</td>
                    <td class="py-3 px-6">${item.minStock || '-'}</td>
                    <td class="py-3 px-6 max-w-xs text-wrap">${item.description || 'Tidak ada deskripsi.'}</td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center space-x-2">
                            <button onclick="window.editItem('${item.id}', '${item.name}', '${item.code || ''}', '${item.photo || ''}', ${item.stock}, ${item.minStock || '0'}, '${item.description || ''}')"
                                    class="bg-blue-500 text-white text-sm py-1 px-3 rounded-md hover:bg-blue-600 btn-animation">
                                Edit
                            </button>
                            <button onclick="window.deleteItem('${item.id}')"
                                    class="bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600 btn-animation">
                                Hapus
                            </button>
                        </div>
                    </td>
                `;
                stockList.appendChild(row);
            });
        }

        // Fungsi untuk menambahkan atau mengupdate produk
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const id = itemIdInput.value;
            const name = itemNameInput.value.trim();
            const code = itemCodeInput.value.trim();
            const photo = itemPhotoInput.value.trim();
            const stock = parseInt(itemStockInput.value, 10);
            const minStock = parseInt(itemMinStockInput.value, 10);
            const description = itemDescriptionTextarea.value.trim();

            if (!name || isNaN(stock)) {
                showModal("Nama produk atau stok tidak valid. Harap periksa input Anda.");
                return;
            }

            if (id) {
                // Mode Edit
                const index = stockData.findIndex(item => item.id === id);
                if (index > -1) {
                    stockData[index].name = name;
                    stockData[index].code = code;
                    stockData[index].photo = photo;
                    stockData[index].stock = stock;
                    stockData[index].minStock = minStock;
                    stockData[index].description = description;
                    showModal(`Produk '${name}' berhasil diupdate.`);
                }
            } else {
                // Mode Tambah
                const newItem = {
                    id: crypto.randomUUID(),
                    name: name,
                    code: code,
                    photo: photo,
                    stock: stock,
                    minStock: minStock,
                    description: description
                };
                stockData.push(newItem);
                showModal(`Produk '${name}' berhasil ditambahkan.`);
            }
            saveData();
            renderData();
            hideItemModal();
        });

        // Fungsi untuk mengisi form saat tombol edit diklik
        window.editItem = function(id, name, code, photo, stock, minStock, description) {
            itemIdInput.value = id;
            itemNameInput.value = name;
            itemCodeInput.value = code;
            itemPhotoInput.value = photo;
            itemStockInput.value = stock;
            itemMinStockInput.value = minStock;
            itemDescriptionTextarea.value = description;
            modalTitle.textContent = 'Edit Produk';
            formButton.textContent = 'Update';
            showItemModal();
        };

        // Fungsi untuk menghapus produk
        window.deleteItem = function(id) {
            stockData = stockData.filter(item => item.id !== id);
            saveData();
            renderData();
            showModal("Produk berhasil dihapus.");
        };

        // Fungsi untuk menghasilkan deskripsi menggunakan Gemini API
        generateDescriptionButton.addEventListener('click', async function() {
            const productName = itemNameInput.value.trim();
            if (!productName) {
                showModal("Harap masukkan nama produk terlebih dahulu.");
                return;
            }

            // Ganti teks tombol dan nonaktifkan selama pemrosesan
            const originalButtonText = generateDescriptionButton.textContent;
            generateDescriptionButton.textContent = 'Memproses...';
            generateDescriptionButton.disabled = true;

            try {
                const userQuery = `Buat deskripsi singkat dan menarik (maksimal 50 kata) untuk produk bernama '${productName}'. Fokus pada kegunaan, fungsi, dan keunggulan produk tersebut. Balas dalam satu paragraf.`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    itemDescriptionTextarea.value = generatedText;
                } else {
                    showModal('Gagal menghasilkan deskripsi. Silakan coba lagi.');
                }
            } catch (error) {
                console.error("API Call Error:", error);
                showModal('Terjadi kesalahan saat memanggil API. Silakan coba lagi nanti.');
            } finally {
                // Kembalikan teks tombol dan aktifkan kembali
                generateDescriptionButton.textContent = originalButtonText;
                generateDescriptionButton.disabled = false;
            }
        });

        // ==========================================
        // FITUR EKSPOR DAN IMPOR DATA
        // ==========================================

        // Fungsi untuk menyalin teks ke clipboard
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showModal("Data berhasil disalin ke clipboard!");
            } catch (err) {
                // Fallback jika API Clipboard tidak tersedia
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showModal("Data berhasil disalin ke clipboard!");
            }
        }

        // Listener untuk tombol Ekspor
        exportButton.addEventListener('click', () => {
            const dataToExport = localStorage.getItem(STORAGE_KEY);
            if (!dataToExport || dataToExport === '[]') {
                showModal("Tidak ada data untuk diekspor. Tambahkan produk terlebih dahulu.");
                return;
            }
            copyToClipboard(dataToExport);
        });

        // Listener untuk menampilkan bagian Impor
        showImportButton.addEventListener('click', () => {
            importSection.classList.remove('hidden');
        });

        // Listener untuk tombol Impor
        importButton.addEventListener('click', () => {
            const importedDataString = importDataTextarea.value.trim();
            if (!importedDataString) {
                showModal("Tempelkan data di kotak teks terlebih dahulu.");
                return;
            }

            try {
                const importedData = JSON.parse(importedDataString);
                if (Array.isArray(importedData)) {
                    stockData = importedData;
                    saveData();
                    renderData();
                    showModal("Data berhasil diimpor! Halaman akan di-refresh untuk menerapkan perubahan.");
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showModal("Data yang ditempelkan tidak valid. Pastikan itu adalah format JSON yang benar.");
                }
            } catch (e) {
                showModal("Terjadi kesalahan saat mengimpor data. Pastikan format JSON sudah benar.");
                console.error("Error parsing imported data:", e);
            }
            importSection.classList.add('hidden');
            importDataTextarea.value = '';
        });

        // Listener untuk tombol Batal Impor
        cancelImportButton.addEventListener('click', () => {
            importSection.classList.add('hidden');
            importDataTextarea.value = '';
        });

        // ==========================================
        // FITUR POP-UP
        // ==========================================
        showAddModalButton.addEventListener('click', () => {
            hideItemModal(); // Pastikan form bersih saat membuka modal baru
            modalTitle.textContent = 'Tambah Produk';
            formButton.textContent = 'Simpan';
            showItemModal();
        });

        // Listener untuk tombol menutup modal item
        closeItemModalButton.addEventListener('click', hideItemModal);

        // Listener untuk menutup modal saat mengklik di luar konten
        itemModal.addEventListener('click', (event) => {
            if (event.target === itemModal) {
                hideItemModal();
            }
        });

        // Memuat data saat aplikasi pertama kali dijalankan
        loadData();
    </script>
</body>
</html>
